import{v as e,b as t,r as n,d as s,u as i,q as o,o as r,c as a,j as c,E as d,p as l,k as u,e as h}from"./index-61faf58b.js";import{a as p}from"./index-ea2c32ca.js";import{a as f}from"./index-218e5d70.js";import{J as m,$ as v,S as g,u as b}from"./spin-6a0725f6.js";import{c as _}from"./index-fdc8fc42.js";import{_ as w}from"./_plugin-vue_export-helper-1b428a4d.js";import"./index-4154bb8a.js";const{wsCache:y}=e(),k=t(),x="undefined"!=typeof RTCPeerConnection?RTCPeerConnection:require("wrtc").RTCPeerConnection;class C{constructor(e){this._callback=null,this.incomingStream=null,this.outgoingStream=null,this._rtc=e,this._offerToReceive=!1}subscribe(e){this._callback=e,this.offerToReceive()}putSubscription(e){this.outgoingStream=e,this._rtc.addTrack(e)}offerToReceive(){this._offerToReceive=!0}_onTrack(e){this.incomingStream=e.streams[0],null!=this._callback&&this._callback(e.streams[0])}}class S{constructor(e=!0,t={iceServers:[{urls:y.get(k.server).turnServer,username:y.get(k.server).turnUsername,credential:y.get(k.server).turnCredential}]}){this._dataChannels={},this._msgcallback=e=>_.log(e),this._rtc=new x(t),this._rtc.ondatachannel=this._onDataChannel.bind(this),this._rtc.ontrack=this._onTrack.bind(this),this.video=new C(this._rtc),this.audio=new C(this._rtc),this._hasRemoteDescription=!1,this._defaultChannel=null,this._defaultOrdered=e,this.__queuedMessages=[],this.put_nowait=this.put_nowait.bind(this)}async _waitForICECandidates(){const e=this._rtc;await new Promise((function(t){if("complete"===e.iceGatheringState)t();else{let n=function(){"complete"===e.iceGatheringState&&(e.removeEventListener("icegatheringstatechange",n),t())};e.addEventListener("icegatheringstatechange",n)}}))}async getLocalDescription(e=null){if(this._hasRemoteDescription||null!=e){this._hasRemoteDescription||await this.setRemoteDescription(e);let t=await this._rtc.createAnswer();return await this._rtc.setLocalDescription(t),await this._waitForICECandidates(),{sdp:this._rtc.localDescription.sdp,type:this._rtc.localDescription.type}}this._defaultChannel=this._rtc.createDataChannel("default",{ordered:this._defaultOrdered}),this._defaultChannel.onmessage=this._onMessage.bind(this,this._defaultChannel),this._defaultChannel.onopen=this._sendQueuedMessages.bind(this);let t=await this._rtc.createOffer({offerToReceiveVideo:this.video._offerToReceive,offerToReceiveAudio:this.audio._offerToReceive});return await this._rtc.setLocalDescription(t),await this._waitForICECandidates(),this._rtc.localDescription}async setRemoteDescription(e){await this._rtc.setRemoteDescription(e),this._hasRemoteDescription=!0}_sendQueuedMessages(){if(this.__queuedMessages.length>0){for(let e=0;e<this.__queuedMessages.length;e++)this._defaultChannel.send(this.__queuedMessages[e]);this.__queuedMessages=[]}}_onDataChannel(e){_.log(e),(e=e.channel).onmessage=this._onMessage.bind(this,e),"default"==e.label?(this._defaultChannel=e,e.onopen=()=>this._sendQueuedMessages()):e.onopen=()=>this._dataChannels[e.label]=e}_onTrack(e){switch(e.track.kind){case"video":this.video._onTrack(e);break;case"audio":this.audio._onTrack(e);break;default:_.error("Could not recognize track!")}}_onMessage(e,t){this._msgcallback(t.data)}subscribe(e){this._msgcallback=e}put_nowait(e){"string"!=typeof e&&(e=JSON.stringify(e)),null!=this._defaultChannel&&"open"==this._defaultChannel.readyState&&0==this.__queuedMessages.length?this._defaultChannel.send(e):this.__queuedMessages.push(e)}async close(){for(let e in this._dataChannels)e.close();null!=this._defaultChannel&&this._defaultChannel.close(),await this._rtc.close()}}class E{constructor(){this._de=this._downEvent.bind(this),this._ue=this._upEvent.bind(this),this._md=this._mdownEvent.bind(this),this._mu=this._mupEvent.bind(this),this._mm=this._moverEvent.bind(this),window.addEventListener("keydown",this._de),window.addEventListener("keyup",this._ue);const e=document.getElementById("tmc-screen");e.addEventListener("mousedown",this._md),e.addEventListener("mouseup",this._mu),e.addEventListener("mousemove",this._mm),document.oncontextmenu=e=>{window.event&&(e=window.event);try{var t=e.srcElement;return"tmc"!=t.className||(_.log(t.className),!1)}catch(n){return!1}};const t=document.getElementById("video-group-screen");this.height=t.clientHeight,this.width=2560*t.clientHeight/1440,this._subscription=_.log}_downEvent(e){const t={action:"LinuxInputEvent",extras:{code:e.keyCode,key:e.key,input:2,type:1,value:1}};e.repeat||this._subscription(t),e.preventDefault()}_upEvent(e){const t={action:"LinuxInputEvent",extras:{code:e.keyCode,key:e.key,input:2,type:1,value:0}};this._subscription(t),e.preventDefault()}_mdownEvent(e){const t={action:"LinuxInputEvent",extras:{code:272,input:1,type:1,value:1,x:e.offsetX/this.width,y:e.offsetY/this.height}};0===e.button?this._subscription(t):1===e.button?(t.extras.code=274,this._subscription(t)):2===e.button&&(t.extras.code=273,this._subscription(t)),e.preventDefault()}_mupEvent(e){const t={action:"LinuxInputEvent",extras:{code:272,input:1,type:1,value:0,x:e.offsetX/this.width,y:e.offsetY/this.height}};0===e.button?this._subscription(t):1===e.button?(t.extras.code=274,this._subscription(t)):2===e.button&&(t.extras.code=273,this._subscription(t)),e.preventDefault()}_moverEvent(e){_.log(this.width,this.height);const t={action:"LinuxInputEvent",extras:{code:0,input:1,type:2,value:"",x:e.offsetX/this.width,y:e.offsetY/this.height}};this._subscription(t),e.preventDefault()}subscribe(e){this._subscription=e}close(){window.removeEventListener("keydown",this._de),window.removeEventListener("keyup",this._ue)}}const I=()=>{const e=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");const t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))},t=function(e){if(e){let t=e.replace(new RegExp("<","g"),"&lt");return t=t.replace(new RegExp(">","g"),"&gt"),t}};let s=null;s="http:"===window.location.protocol?"http://10.180.151.100:8088/janus":"https://10.180.151.100:8089/janus";const i=n(!1);let o=null,r=null;const a="videoroomtest-"+m.randomString(12);let c=2014;""!==e("room")&&(c=parseInt(e("room")));let d=null,l=null,u=null,h=null,p={},f=0;const b=[],_={},w=[],y="yes"===e("msid")||"true"===e("msid");const k=function(e){const n={request:"join",room:e,ptype:"publisher",display:"lxj"};d=t("lxj"),r.send({message:n})},x=function(e,n,s,i){let r=null;s||(s=_[e]),o.attach({plugin:"janus.plugin.videoroom",opaqueId:a,success:function(n){r=n,r.remoteTracks={},r.remoteVideos=0,r.simulcastStarted=!1,m.log("Plugin attached! ("+r.getPlugin()+", id="+r.getId()+")"),m.log("  -- This is a subscriber");const o=[];for(const e in s){const n=s[e];("video"!==n.type||"safari"!==m.webRTCAdapter.browserDetails.browser||"vp9"!==n.codec&&("vp8"!==n.codec||m.safariVp8))&&(o.push({feed:n.id,mid:n.mid}),r.rfid=n.id,r.rfdisplay=t(n.display))}const a={request:"join",room:i,ptype:"subscriber",feed:e,use_msid:y,private_id:h};r.send({message:a}),T()},error:function(e){m.error("  -- Error attaching plugin...",e)},iceState:function(e){m.log("ICE state (feed #"+r.rfindex+") changed to "+e)},webrtcState:function(e){m.log("Janus says this WebRTC PeerConnection (feed #"+r.rfindex+") is "+(e?"up":"down")+" now")},slowLink:function(e,t,n){m.warn("Janus reports problems "+(e?"sending":"receiving")+" packets on mid "+n+" ("+t+" lost packets)")},onmessage:function(e,t){m.debug(" ::: Got a message (subscriber) :::",e);const n=e.videoroom;if(m.debug("Event: "+n),e.error);else if(n)if("attached"===n){for(let e=1;e<6;e++)if(!b[e]){b[e]=r,r.rfindex=e;break}if(r.spinner)r.spinner.spin();else{const e=document.getElementById("videoremote");r.spinner=new g({top:100}).spin(e)}m.log("Successfully attached to feed in room "+e.room),v("#remote"+r.rfindex).removeClass("hide").html(r.rfdisplay).show()}else if("event"===n){const t=e.substream,n=e.temporal;null==t&&null==n||r.simulcastStarted||(r.simulcastStarted=!0)}if(t){m.debug("Handling SDP as well...",t);const e=-1!==t.sdp.indexOf("stereo=1");r.createAnswer({jsep:t,tracks:[{type:"data"}],customizeSdp:function(t){e&&-1==t.sdp.indexOf("stereo=1")&&(t.sdp=t.sdp.replace("useinbandfec=1","useinbandfec=1;stereo=1"))},success:function(e){m.debug("Got SDP!",e);const t={request:"start",room:c};r.send({message:t,jsep:e})},error:function(e){m.error("WebRTC error:",e)}})}},onlocaltrack:function(e,t){},onremotetrack:function(e,t,n){if(m.debug("Remote feed #"+r.rfindex+", remote track (mid="+t+") "+(n?"added":"removed")+":",e),!n){const n=r.remoteTracks[t];if(n)try{const e=n.getTracks();for(const t in e){const n=e[t];null!=n&&n.stop()}}catch(s){}return"video"===e.kind&&(r.remoteVideos--,0===r.remoteVideos&&0===v("#videoremote .no-video-container").length&&v("#videoremote").append('<div class="no-video-container"><i class="fa fa-video-camera fa-5 no-video-icon"></i><span class="no-video-text">No remote video available</span></div>')),void delete r.remoteTracks[t]}if(r.spinner&&(r.spinner.stop(),r.spinner=null),"audio"===e.kind){const n=new MediaStream([e]);r.remoteTracks[t]=n,m.log("Created remote audio stream:",n),v("#videoremote").append('<audio class="hide" id="remotevideo-screen'+r.rfindex+"-"+t+'" autoplay playsinline/>'),m.attachMediaStream(document.getElementById("remotevideo-screen"),n),0===r.remoteVideos&&0===v("#videoremote .no-video-container").length&&v("#videoremote").append('<div class="no-video-container"><i class="fa fa-video-camera fa-5 no-video-icon"></i><span class="no-video-text">No remote video available</span></div>')}else{r.remoteVideos++,v("#videoremote"+r.rfindex+" .no-video-container").remove();const n=new MediaStream([e]);r.remoteTracks[t]=n,m.log("Created remote video stream:",n),v("#videoremote").append('<video class="rounded centered" id="remotevideo-screen'+r.rfindex+"-"+t+'" width=100% autoplay playsinline/>'),v("#videoremote").append('<span class="label label-primary hide" id="curres'+r.rfindex+'" style="position: absolute; bottom: 0px; left: 0px; margin: 15px;"></span><span class="label label-info hide" id="curbitrate'+r.rfindex+'" style="position: absolute; bottom: 0px; right: 0px; margin: 15px;"></span>'),m.attachMediaStream(document.getElementById("remotevideo-screen"),n),w[r.rfindex]||(v("#curbitrate"+r.rfindex).removeClass("hide").show(),w[r.rfindex]=setInterval((function(){if(!v("#videoremote video").get(0))return;const e=r.getBitrate();v("#curbitrate"+r.rfindex).text(e);const t=v("#videoremote video").get(0).videoWidth,n=v("#videoremote video").get(0).videoHeight;t>0&&n>0&&v("#curres"+r.rfindex).removeClass("hide").text(t+"x"+n).show()}),1e3))}},onremotestream:t=>{console.log("feed id"+e),m.attachMediaStream(document.getElementById("videoremote"),t)},oncleanup:function(){m.log(" ::: Got a cleanup notification (remote feed "+e+") :::"),r.spinner&&r.spinner.stop(),r.spinner=null,v("#remotevideo-screen"+r.rfindex).remove(),v("#waitingvideo"+r.rfindex).remove(),v("#novideo"+r.rfindex).remove(),v("#curbitrate"+r.rfindex).remove(),v("#curres"+r.rfindex).remove(),w[r.rfindex]&&clearInterval(w[r.rfindex]),w[r.rfindex]=null,r.simulcastStarted=!1,v("#simulcast"+r.rfindex).remove(),r.remoteTracks={},r.remoteVideos=0}})};let C,I;function T(){document.querySelector("#tmc-screen").style.cursor="none",I=v("#remotevideo-screen").height(),v("#remotevideo-screen").width(1980*I/1080),C=v("#remotevideo-screen").width();const e=v("#remotevideo-screen").offset().left;console.log(I,C),v("#tmc-screen").css({width:C,height:I,position:"absolute","z-index":100,top:0,left:e,background:"#f00",opacity:0})}return v(window).resize((()=>{T()})),{connect:async function(e){const t=new S,n=new E,s=await t.getLocalDescription(),o=await fetch(e+"/connect",{method:"POST",cache:"no-cache",body:JSON.stringify(s)});await t.setRemoteDescription(await o.json()),n.subscribe(t.put_nowait),i.value=!0,console.log("Ready!")},attach_video_room:function(e,t){m.init({debug:"all",callback:function(){v(this).attr("disabled",!0).unbind("click"),m.isWebrtcSupported()&&(o=new m({server:s,iceServers:null,success:function(){o.attach({plugin:"janus.plugin.videoroom",opaqueId:a,success:function(e){r=e,m.log("Plugin attached! ("+r.getPlugin()+", id="+r.getId()+")"),m.log("  -- This is a publisher/manager"),k(t),r.send()},error:function(e){m.error("  -- Error attaching plugin...",e)},consentDialog:function(e){m.debug("Consent dialog should be "+(e?"on":"off")+" now")},iceState:function(e){m.log("ICE state changed to "+e)},mediaState:function(e,t,n){m.log("Janus "+(t?"started":"stopped")+" receiving our "+e+" (mid="+n+")")},webrtcState:function(e){m.log("Janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now")},slowLink:function(e,t,n){m.warn("Janus reports problems "+(e?"sending":"receiving")+" packets on mid "+n+" ("+t+" lost packets)")},onmessage:function(n,s){m.debug(" ::: Got a message (publisher) :::",n);const i=n.videoroom;if(m.debug("Event: "+i),i)if("joined"===i){l=n.id,h=n.private_id,m.log("Successfully joined room "+n.room+" with ID "+l);x(e,null,[],t)}else if("destroyed"===i)m.warn("The room has been destroyed!");else if("event"===i)if(n.streams){const e=n.streams;for(const t in e){const n=e[t];n.id=l,n.display=d}_[l]=e}else if(n.publishers){const e=n.publishers;console.log("newRemoteFeed2  Got a list of available publishers/feeds:",e);for(const t in e){if(e[t].dummy)continue;const n=e[t].id,s=e[t].display,i=e[t].streams;for(const e in i){const t=i[e];t.id=n,t.display=s}_[n]=i,console.log(" newRemoteFeed2 >> ["+n+"] "+s+":",i);break}}else if(n.leaving){const e=n.leaving;m.log("Publisher left: "+e);let t=null;for(let n=1;n<6;n++)if(b[n]&&b[n].rfid==e){t=b[n];break}t&&(m.debug("Feed "+t.rfid+" ("+t.rfdisplay+") has left the room, detaching"),b[t.rfindex]=null,t.detach()),delete _[e]}else if(n.unpublished){const e=n.unpublished;if(m.log("Publisher left: "+e),"ok"===e)return void r.hangup();let t=null;for(let n=1;n<6;n++)if(b[n]&&b[n].rfid==e){t=b[n];break}t&&(m.debug("Feed "+t.rfid+" ("+t.rfdisplay+") has left the room, detaching"),b[t.rfindex]=null,t.detach()),delete _[e]}else n.error&&426===n.error_code&&m.debug("This is a no such room error: give a more meaningful description");if(s){m.debug("Handling SDP as well...",s),r.handleRemoteJsep({jsep:s});n.audio_codec;u&&u.getAudioTracks()&&u.getAudioTracks().length;n.video_codec;u&&u.getVideoTracks()&&u.getVideoTracks().length}},onlocaltrack:function(e,t){m.debug("Local track "+(t?"added":"removed")+":",e);const n=e.id.replace(/[{}]/g,"");if(!t){const t=p[n];if(t)try{const e=t.getTracks();for(const t in e){const n=e[t];null!=n&&n.stop()}}catch(s){}return"video"===e.kind&&(f--,0===f&&m.log("No video, at least for now: show a placeholder:")),void delete p[n]}p[n]},onremotetrack:function(e,t,n){},oncleanup:function(){m.log(" ::: Got a cleanup notification: we are unpublished now :::"),u=null,delete _[l],p={},f=0}})},error:function(e){m.error(e)},destroyed:function(){window.location.reload()}}))}})}}},T=e=>(l("data-v-c3f2fc20"),e=e(),u(),e),R={id:"video-group-screen",class:"video-group"},D=[T((()=>h("video",{id:"remotevideo-screen",class:"w-[100%] h-[100%]",controls:"",autoplay:"",muted:""},null,-1))),T((()=>h("div",{id:"tmc-screen",class:"tmc"},null,-1)))],L=w(s({__name:"DeviceScreen",setup(s){const{wsCache:l}=e(),u=t(),{attach_video_room:h,connect:m}=I(),v=b(),{t:g}=c(),{currentRoute:_}=i(),w=n(!1),y=o([]);let k=o([]);const x=_.value.query,C=n(!1);(async()=>{const e=await p(x).catch((()=>{})).finally((()=>{w.value=!1}));if(null==e?void 0:e.success){const t=e.data.filter((e=>"hub"===e.deviceType)),n=e.data.filter((e=>"stb"===e.deviceType));k=e.data.filter((e=>"container"===e.deviceType)),t.length||y.push({label:g("绑定hub"),keys:[g("绑定hub")]}),n.length||y.push({label:g("绑定stb"),keys:[g("绑定stb")]}),t.length&&n.length?C.value=!0:C.value=!1,E(k)}})();const S=n("OFFLINE"),E=async e=>{await v.initWebsocket();const t={deviceId:e[0].deviceId};v.sendWebSocketMessage(t,2,"container_status"),v.getWebsocket.onmessage=e=>{var t;const n=JSON.parse(e.data);if(console.log(e),2===n.requestId){console.log("查询状态"),S.value=n.data.deviceStatus;const e={stunServer:n.data.stunServer||"",turnUsername:n.data.turnUserName,turnCredential:n.data.turnCredential,turnServer:n.data.turnServer};l.set(u.server,e),"ONLINE"===(null==(t=n.data)?void 0:t.deviceStatus)&&(m(n.data.rtcbotConnectUrl),h(n.data.publisherId,n.data.roomId))}else if(3===n.requestId)w.value=!1;else if(4===n.requestId)w.value=!1,S.value="OFFLINE";else{S.value=n.deviceStatus;const e={stunServer:n.stunServer||"",turnUsername:n.turnUserName,turnCredential:n.turnCredential,turnServer:n.turnServer};l.set(u.server,e),"ONLINE"===n.deviceStatus&&(m(n.rtcbotConnectUrl),h(n.publisherId,n.roomId))}n.success||3!==n.requestId||d.error("容器正在关闭中，请稍后再进行操作"),n.success||4!==n.requestId||d.error("容器正在启动中，请稍后再进行操作")}},T=n();return(async()=>{const e={workstationId:x.workstationId},t=await f(e);t&&t.success&&(T.value=t.data[0].roomId)})(),(e,t)=>(r(),a("div",R,D))}}),[["__scopeId","data-v-c3f2fc20"]]);export{L as default};
